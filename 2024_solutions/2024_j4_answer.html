<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>CCC 2024 J4 - ç®—æ³•å¯è§†åŒ– - set-based æ¨ç†</title>
    <style>
        body {
            font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
            background-color: #f0f4f8;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
        }

        .controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .visualization {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            min-height: 300px;
        }

        .string-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .label {
            font-weight: bold;
            width: 80px;
            text-align: right;
            margin-right: 15px;
            color: #7f8c8d;
        }

        .char-box {
            display: inline-flex;
            width: 40px;
            height: 40px;
            justify-content: center;
            align-items: center;
            border: 2px solid #ddd;
            margin: 0 2px;
            border-radius: 4px;
            font-size: 20px;
            transition: all 0.3s;
            position: relative;
        }

        .pointer {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: transparent;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            transition: left 0.3s ease-in-out;
            z-index: 10;
        }

        .pointer-in {
            border-bottom: 15px solid #e74c3c;
            /* Red Input Pointer */
            bottom: -20px;
        }

        .pointer-out {
            border-top: 15px solid #27ae60;
            /* Green Output Pointer */
            top: -20px;
        }

        /* å˜é‡çŠ¶æ€é¢æ¿ */
        .status-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 6px;
        }

        .status-item {
            text-align: center;
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .status-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
            display: block;
        }

        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .log {
            height: 150px;
            overflow-y: auto;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-success {
            color: #2ecc71;
        }

        .log-error {
            color: #e74c3c;
        }

        .log-info {
            color: #3498db;
        }

        .log-warn {
            color: #f39c12;
        }

        /* çŠ¶æ€æ ·å¼ */
        .char-current {
            background-color: #f1c40f !important;
            border-color: #f39c12 !important;
            transform: scale(1.1);
        }

        .char-match {
            background-color: #2ecc71 !important;
            color: white !important;
            border-color: #27ae60 !important;
        }

        .char-silly {
            background-color: #e74c3c !important;
            color: white !important;
            border-color: #c0392b !important;
        }

        .char-quiet {
            background-color: #bdc3c7 !important;
            color: #7f8c8d !important;
            border-color: #95a5a6 !important;
            opacity: 0.6;
        }

        .char-wrong {
            background-color: #9b59b6 !important;
            color: white !important;
        }

        .hidden {
            display: none;
        }

        .highlight {
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>

<body>

    <h1>CCC 2024 J4 - ç®—æ³•å¯è§†åŒ–</h1>

    <div class="controls">
        <input type="text" id="inputStr" value="for loops" placeholder="è¾“å…¥å­—ç¬¦ä¸² (Input)">
        <input type="text" id="outputStr" value="fxr lxpps" placeholder="è¾“å‡ºå­—ç¬¦ä¸² (Output)">
        <button onclick="startVisualization()">å¼€å§‹è¿è¡Œ (Start)</button>
        <button onclick="stopVisualization()" style="background-color: #e74c3c;">åœæ­¢ (Stop)</button>
        <div style="flex-grow: 1; text-align: right;">
            é€Ÿåº¦: <input type="range" id="speed" min="50" max="1000" value="700" style="width: 100px;">
        </div>
    </div>

    <div class="visualization">

        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">å€™é€‰åé”® (Candidates)</span>
                <span class="status-value" id="val-candidates">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">å½“å‰åé”® (Silly)</span>
                <span class="status-value" id="val-silly">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ¨å¯¼é”™å­— (Wrong Char)</span>
                <span class="status-value" id="val-wrong">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ¨å¯¼é™éŸ³é”® (Quiet)</span>
                <span class="status-value" id="val-quiet">-</span>
            </div>
        </div>

        <div class="string-container" id="inputContainer">
            <div class="label">Input</div>
            <div id="inputChars"></div>
            <!-- æŒ‡é’ˆç”±JSåŠ¨æ€æ·»åŠ  -->
        </div>

        <div class="string-container" id="outputContainer">
            <div class="label">Output</div>
            <div id="outputChars"></div>
            <!-- æŒ‡é’ˆç”±JSåŠ¨æ€æ·»åŠ  -->
        </div>

        <div class="log" id="logConsole"></div>

    </div>

    <script>
        let isRunning = false;
        let stopWrapper = { stop: false };

        function log(msg, type = 'info') {
            const consoleEl = document.getElementById('logConsole');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerText = `> ${msg}`;
            consoleEl.appendChild(entry);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logConsole').innerHTML = '';
        }

        function createChars(str, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous
            for (let i = 0; i < str.length; i++) {
                const span = document.createElement('span');
                span.className = 'char-box';
                span.innerText = str[i];
                span.id = `${containerId}-char-${i}`;
                container.appendChild(span);
            }
        }

        function updateStatus(id, val) {
            document.getElementById(`val-${id}`).innerText = val !== null ? val : '-';
        }

        // Delay helper
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function startVisualization() {
            if (isRunning) return;
            isRunning = true;
            stopWrapper.stop = false; // Reset stop flag
            clearLog();

            const inputStr = document.getElementById('inputStr').value;
            const outputStr = document.getElementById('outputStr').value;
            const speed = parseInt(document.getElementById('speed').value);
            const waitTime = () => 1050 - parseInt(document.getElementById('speed').value);

            createChars(inputStr, 'inputChars');
            createChars(outputStr, 'outputChars');

            log(`å¼€å§‹åˆ†æ... input="${inputStr}", output="${outputStr}"`);

            const inputSet = new Set(inputStr);
            const outputSet = new Set(outputStr);

            let candidates = [...inputSet].filter(x => !outputSet.has(x));
            candidates.sort();

            log(`è®¡ç®—å€™é€‰åé”®: set(Input) - set(Output) = {${candidates.join(',')}}`);

            if (candidates.length === 0) {
                log("å·®é›†ä¸ºç©ºï¼Œé€€å›åˆ° inputSet", "warn");
                candidates = [...inputSet].sort();
            }

            updateStatus('candidates', `{${candidates.join(',')}}`);

            // 2. Loop Candidates
            for (let silly of candidates) {
                if (stopWrapper.stop) break;

                log(`\n--- å°è¯•å‡è®¾ï¼šåé”® Silly = '${silly}' ---`, 'info');
                updateStatus('silly', silly);
                updateStatus('wrong', null);
                updateStatus('quiet', null);

                // Reset visual styles
                document.querySelectorAll('.char-box').forEach(el => el.className = 'char-box');

                let pj = 0;
                let quiet = null;
                let wrongChar = null;
                let possible = true;

                for (let pi = 0; pi < inputStr.length; pi++) {
                    if (stopWrapper.stop) { possible = false; break; }

                    const inEl = document.getElementById(`inputChars-char-${pi}`);
                    inEl.classList.add('char-current');

                    // Highlight corresponding output char if exists
                    let outEl = null;
                    if (pj < outputStr.length) {
                        outEl = document.getElementById(`outputChars-char-${pj}`);
                        if (outEl) outEl.classList.add('char-current');
                    }

                    await delay(waitTime());

                    const inChar = inputStr[pi];
                    let isQuiet = false;

                    // 1. Quiet Key Check (Known)
                    if (inChar === quiet) {
                        log(`  [${pi}] '${inChar}' æ˜¯å·²çŸ¥çš„é™éŸ³é”®ï¼Œè·³è¿‡`, 'info');
                        inEl.className = 'char-box char-quiet';
                        if (outEl) outEl.classList.remove('char-current');
                        isQuiet = true;
                    }

                    // 2. Silly Key Check
                    else if (inChar === silly) {
                        log(`  [${pi}] '${inChar}' æ˜¯åé”® (Silly)`, 'info');
                        inEl.className = 'char-box char-silly';

                        if (pj >= outputStr.length) {
                            log(`    Error: éœ€è¦è¾“å‡ºå­—ç¬¦ï¼Œä½† Output å·²è€—å°½`, 'error');
                            possible = false;
                            if (outEl) outEl.classList.remove('char-current');
                            inEl.classList.add('char-wrong');
                            break;
                        }

                        const currentOutChar = outputStr[pj];

                        if (wrongChar === null) {
                            wrongChar = currentOutChar;
                            updateStatus('wrong', wrongChar);
                            log(`    æ¨å¯¼: åé”®åº”è¯¥æ˜¾ç¤ºä¸º '${wrongChar}'`, 'success');
                        } else if (currentOutChar !== wrongChar) {
                            log(`    Error: åé”®æ˜¾ç¤ºä¸ä¸€è‡´! æœŸæœ› '${wrongChar}', å®é™… '${currentOutChar}'`, 'error');
                            possible = false;
                            if (outEl) outEl.classList.remove('char-current');
                            inEl.classList.add('char-wrong');
                            break;
                        }

                        if (outEl) {
                            outEl.className = 'char-box char-wrong';
                            // Remove current highlight from outEl so we can see the color
                            outEl.classList.remove('char-current');
                        }
                        pj++;
                    }

                    // 3. Normal / Potential Quiet Inference
                    else {
                        // Match Case
                        if (pj < outputStr.length && inChar === outputStr[pj]) {
                            log(`  [${pi}] '${inChar}' åŒ¹é… Output[${pj}]`, 'success');
                            inEl.className = 'char-box char-match';
                            if (outEl) {
                                outEl.className = 'char-box char-match';
                                outEl.classList.remove('char-current');
                            }
                            pj++;
                        }
                        // Mismatch Case -> Must be Quiet
                        else {
                            if (quiet === null) {
                                quiet = inChar;
                                updateStatus('quiet', quiet);
                                inEl.className = 'char-box char-quiet';
                                log(`  [${pi}] '${inChar}' ä¸åŒ¹é… -> æ¨å¯¼ä¸ºé™éŸ³é”® (Quiet)`, 'success');
                                if (outEl) outEl.classList.remove('char-current');
                                // Do not increment pj
                            } else {
                                // Already have a quiet key, and this isn't it (checked at step 1), 
                                // and it doesn't match output. So it's an error.
                                log(`    Error: '${inChar}' ä¸åŒ¹é…ï¼Œä¸”é™éŸ³é”®å·²å®šä¸º '${quiet}'`, 'error');
                                possible = false;
                                if (outEl) outEl.classList.remove('char-current');
                                inEl.classList.add('char-wrong');
                                break;
                            }
                        }
                    }

                    inEl.classList.remove('char-current'); // Remove highlight from current input
                    await delay(waitTime() / 2);
                }

                if (stopWrapper.stop) break;

                if (possible && pj === outputStr.length) {
                    log(`\nğŸ‰ éªŒè¯æˆåŠŸ!`, 'success');
                    const resultMsg = `Silly: ${silly} (${wrongChar})\nQuiet: ${quiet ? quiet : '-'}`;
                    log(resultMsg, 'success');
                    alert(`æ‰¾åˆ°æ­£è§£!\n${resultMsg}`);
                    isRunning = false;
                    return;
                } else {
                    if (possible && pj !== outputStr.length) {
                        log(`Failed: Output è¿˜æœ‰å‰©ä½™å­—ç¬¦æœªåŒ¹é…`, 'error');
                    } else if (!possible) {
                        log(`Failed: å½“å‰å‡è®¾ä¸æˆç«‹`, 'error');
                    }
                }

                await delay(1000);
            }

            if (!stopWrapper.stop) {
                log("æ‰€æœ‰å€™é€‰é”®å°è¯•å®Œæ¯•ï¼Œæœªæ‰¾åˆ°è§£ã€‚", 'error');
            }
            isRunning = false;
        }

        function stopVisualization() {
            if (isRunning) {
                stopWrapper.stop = true;
                log("æ­£åœ¨åœæ­¢...", 'warn');
            }
        }

    </script>

</body>

</html>